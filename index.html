<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>SSO Redirect (Register / Authentication / Status)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body{font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;color:#111}
  h1{font-size:20px;margin:0 0 12px}
  label{font-weight:600;display:block;margin-top:14px}
  textarea{width:100%;height:110px;padding:8px 10px}
  input[type="text"]{width:100%;padding:8px 10px}
  .row{margin-top:8px}
  .controls button{padding:8px 12px;margin:8px 10px 0 0}
  pre{background:#f7f7f9;border:1px solid #e5e5ea;padding:12px;border-radius:8px;white-space:pre-wrap;overflow:auto}
  .muted{color:#666}
  .ok{background:#e8f8ef}.err{background:#fde8e8}
</style>
</head>
<body>
<h1>SSO Redirect — Registration / Authentication / Status</h1>
<p class="muted">
  This page performs a <b>top-level navigation</b> to <code>apps.pingone.com</code> so your Redirect-type SSO extension runs.
  The extension should redirect back here with <code>?state=…&token=…</code> (or fragment <code>#token=…</code>).
</p>

<!-- ==== CONFIG (edit only if needed) ==== -->
<script>
  const SSO_BASE = "https://apps.pingone.com/pingid/desktop";
  const ROUTES = {
    registration: "/register",
    authentication: "/authentication",
    status: "/status",
  };
  const REDIRECT_URI = location.origin + location.pathname; // return to self
</script>
<!-- ===================================== -->

<div class="row">
  <label>Header JSON</label>
  <textarea id="hdr">{ "alg":"HS256", "typ":"JWT" }</textarea>
</div>
<div class="row">
  <label>Body JSON</label>
  <textarea id="pld">{ "user":"alice@example.com", "purpose":"demo" }</textarea>
</div>

<div class="row">
  <label>Send options</label>
  <div>
    <input type="checkbox" id="wrapAsJWT" checked>
    <label for="wrapAsJWT" style="font-weight:400">Wrap request payload as JWT and send (like the original script)</label>
  </div>
</div>

<div class="controls">
  <button onclick="start('registration')">Registration</button>
  <button onclick="start('authentication')">Authentication</button>
  <button onclick="start('status')">Status</button>
  <button onclick="clearView()">Clear</button>
</div>

<div class="row">
  <label>Built Request & Navigation</label>
  <pre id="req">(none)</pre>
</div>

<div class="row">
  <label>Return Data (from SSO redirect back here)</label>
  <pre id="res">(none)</pre>
</div>

<script>
/* ==== helpers ==== */
const isSafari = () => /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const b64u = s => btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const fromB64u = s => atob(s.replace(/-/g,'+').replace(/_/g,'/'));
const rnd = () => Array.from(crypto.getRandomValues(new Uint8Array(16)), x => x.toString(16).padStart(2,'0')).join('');
const set = (id, v) => document.getElementById(id).textContent = v;

function encodeJWT(headerObj, payloadObj){
  const h = b64u(JSON.stringify(headerObj));
  const p = b64u(JSON.stringify(payloadObj));
  const s = b64u("dummy-signature"); // replace with real signing if needed
  return `${h}.${p}.${s}`;
}
function decodeJWT(jwt){
  try{
    const [h,p] = jwt.split('.');
    const hdr = JSON.parse(atob(h.replace(/-/g,'+').replace(/_/g,'/')));
    const pl  = JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));
    return JSON.stringify({header:hdr,payload:pl}, null, 2);
  }catch{
    return "(could not decode JWT)";
  }
}
function prettyJSON(s){
  try { return JSON.stringify(JSON.parse(s), null, 2); }
  catch { return s; }
}

/* ==== kickoff (top-level navigation) ==== */
async function start(kind){
  const route = ROUTES[kind];
  if (!route) { set('req', `Unknown kind: ${kind}`); return; }

  // Persist any page context you want to restore later
  sessionStorage.setItem("ctx_scrollY", String(window.scrollY));

  let header, body;
  try {
    header = JSON.parse(document.getElementById('hdr').value);
    body   = JSON.parse(document.getElementById('pld').value);
  } catch(e) {
    set('req', `Invalid JSON in header or body: ${e.message}`);
    return;
  }

  const wrapAsJWT = document.getElementById('wrapAsJWT').checked;
  const state = rnd();
  sessionStorage.setItem("sso_state", state);

  // Build optional request JWT (your original script behavior)
  const requestJWT = encodeJWT(header, body);

  // Build SSO URL — MUST match your Redirect profile's URLs prefix
  const u = new URL(SSO_BASE + route);
  u.searchParams.set("redirect_uri", REDIRECT_URI); // come back here
  u.searchParams.set("state", state);

  // Send request data the same way your old script did:
  // - when "wrap as JWT" is ON → send the JWT under "request"
  // - when OFF → send the raw JSON body under "payload"
  if (wrapAsJWT) {
    u.searchParams.set("request", requestJWT);
  } else {
    u.searchParams.set("payload", b64u(JSON.stringify(body)));
  }

  // Log what we’re doing (don’t truncate)
  let out = [];
  out.push(`Top-level nav to: ${u.toString()}`);
  out.push(`state: ${state}`);
  if (wrapAsJWT) {
    out.push(`request (JWT):\n${requestJWT}`);
    out.push(`decoded request JWT:\n${decodeJWT(requestJWT)}`);
  } else {
    out.push(`payload (JSON):\n${prettyJSON(JSON.stringify(body))}`);
  }
  set('req', out.join("\n\n"));

  // Invoke the Redirect-type SSO flow (must be top-level)
  window.top.location.assign(u.toString());
}

/* ==== handle return (query or fragment) ==== */
(function handleReturn(){
  const qp = new URLSearchParams(location.search || "");
  const hp = new URLSearchParams((location.hash || "").replace(/^#/,''));
  const get = k => qp.get(k) || hp.get(k);

  const state    = get("state");
  const token    = get("token") || get("jwt") || get("id_token") || get("access_token"); // FULL token (no truncation)
  const payloadB = get("payload"); // if extension returned payload separately (base64url JSON)
  const bodyB64  = get("body");    // if extension returned httpBody (base64url)
  const error    = get("error");

  if (!(token || payloadB || bodyB64 || state || error)) return; // nothing to show

  const expected = sessionStorage.getItem("sso_state");

  let lines = [];
  lines.push(`Returned to: ${REDIRECT_URI}`);
  if (error) lines.push(`error: ${error}`);
  lines.push(`state: ${state || "(missing)"}  expected: ${expected || "(none)"}`);

  if (token) {
    lines.push("\n— token (FULL) —");
    lines.push(token); // NO TRUNCATION
    // Try to decode if it looks like a JWT
    const parts = token.split('.');
    if (parts.length >= 2) {
      try {
        const decoded = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
        lines.push("\n— decoded JWT payload —");
        lines.push(JSON.stringify(decoded, null, 2));
      } catch {}
    }
  }

  if (payloadB) {
    try {
      lines.push("\n— payload (JSON) —");
      lines.push(prettyJSON(fromB64u(payloadB)));
    } catch {
      lines.push("\n— payload (raw base64url) —");
      lines.push(payloadB);
    }
  }

  if (bodyB64) {
    try {
      lines.push("\n— httpBody (UTF-8) —");
      lines.push(fromB64u(bodyB64));
    } catch {
      lines.push("\n— httpBody (base64url) —");
      lines.push(bodyB64);
    }
  }

  const ok = (!error && state && expected && state === expected);
  const resEl = document.getElementById('res');
  resEl.classList.toggle('ok',  ok);
  resEl.classList.toggle('err', !!error);
  set('res', lines.join("\n"));

  // Restore context and clean URL bar
  const y = parseInt(sessionStorage.getItem("ctx_scrollY") || "0", 10);
  setTimeout(()=>window.scrollTo({top:y,behavior:"instant"}), 0);
  const clean = new URL(location.href); clean.search=""; clean.hash="";
  history.replaceState(null, "", clean);
})();

/* ==== clear ==== */
function clearView(){
  sessionStorage.removeItem("sso_state");
  set('req','(none)'); set('res','(none)');
}
</script>
</body>
</html>
