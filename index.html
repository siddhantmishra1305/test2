<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Redirect-type SSO Extension — Top-level Navigation Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font: 14px/1.45 -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color:#111; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { margin: 10px 0; }
    input, button, textarea { padding: 8px 10px; }
    textarea { width:100%; height:110px; }
    pre { background:#f7f7f9; border:1px solid #e5e5ea; padding:12px; border-radius:8px; overflow:auto; }
    .ok { background:#e8f8ef; }
    .err{ background:#fde8e8; }
  </style>
</head>
<body>
  <h1>Redirect-type SSO Extension — Top-level Navigation</h1>

  <!-- ======= CONFIG (EDIT THESE) ======= -->
  <script>
  // Host/prefix that your Redirect SSO profile's URLs include
  const SSO_BASE       = "https://apps.pingone.com/pingid/desktop";   // must match your MDM 'URLs' prefix
  const REGISTER_PATH  = "/register";     // path under SSO_BASE that you navigate to
  const AUTH_PATH      = "/authenticate"; // path under SSO_BASE that you navigate to

  // Where the extension should send the browser back (absolute, on A.com)
  // You can change the path — keep it same-origin so this page can read params
  const REDIRECT_URI   = `${location.origin}/sso/callback`;
  </script>
  <!-- ================================== -->

  <div class="row">
    <label>JWT Header (JSON)</label>
    <textarea id="hdr">{ "alg":"HS256", "typ":"JWT" }</textarea>
  </div>
  <div class="row">
    <label>JWT Payload (JSON)</label>
    <textarea id="pld">{ "user":"alice@example.com", "purpose":"demo" }</textarea>
  </div>

  <div class="row">
    <button onclick="startFlow('registration')">Registration (GET nav)</button>
    <button onclick="startFlow('authentication')">Authentication (GET nav)</button>
  </div>

  <div class="row">
    <h3>Request JWT</h3>
    <pre id="req">(none)</pre>
  </div>

  <div class="row">
    <h3>Callback / Result</h3>
    <pre id="res">(none)</pre>
  </div>

<script>
/* ===== Utilities ===== */
function b64url(str) {
  return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function encodeJWT(headerObj, payloadObj) {
  const h = b64url(JSON.stringify(headerObj));
  const p = b64url(JSON.stringify(payloadObj));
  const s = b64url('dummy-signature'); // replace with real signing if you need it
  return `${h}.${p}.${s}`;
}
function decodeJWT(jwt) {
  try {
    const [h,p] = jwt.split('.');
    const hdr = JSON.parse(atob(h.replace(/-/g,'+').replace(/_/g,'/')));
    const pld = JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));
    return JSON.stringify({ header: hdr, payload: pld }, null, 2);
  } catch {
    return "(could not decode JWT)";
  }
}
function randState() {
  const a = new Uint8Array(16); crypto.getRandomValues(a);
  let s=""; for (let i=0;i<a.length;i++) s+=a[i].toString(16).padStart(2,"0");
  return s;
}

/* ===== Build top-level nav URL and go ===== */
function startFlow(kind) {
  // Build a demo JWT
  let header, payload;
  try {
    header  = JSON.parse(document.getElementById('hdr').value);
    payload = JSON.parse(document.getElementById('pld').value);
  } catch (e) {
    document.getElementById('req').textContent = "Invalid JSON in header/payload";
    return;
  }
  const jwt = encodeJWT(header, payload);
  document.getElementById('req').textContent = jwt;

  const state = randState();               // to validate round-trip
  sessionStorage.setItem("sso_state", state);
  sessionStorage.setItem("sso_req_jwt", jwt);

  const path = (kind === "registration") ? REGISTER_PATH : AUTH_PATH;

  // Build a GET nav URL — MUST match a prefix in your Redirect SSO profile's 'URLs'
  const url = new URL(SSO_BASE + path);
  url.searchParams.set("jwt", jwt);
  url.searchParams.set("redirect_uri", REDIRECT_URI);
  url.searchParams.set("state", state);

  // ✅ Top-level navigation (required for Redirect-type SSO)
  window.top.location.assign(url.toString());
}

/* ===== Callback handler (runs on A.com/REDIRECT_URI) ===== */
(function handleCallbackIfPresent() {
  if (!location.href.startsWith(REDIRECT_URI)) return;

  const out = document.getElementById('res');
  const qp  = new URLSearchParams(location.search);
  const gotState = qp.get("state") || qp.get("s");
  const token    = qp.get("token") || qp.get("jwt") || qp.get("code"); // your extension decides name
  const err      = qp.get("error");

  const expected = sessionStorage.getItem("sso_state");
  const reqJwt   = sessionStorage.getItem("sso_req_jwt");

  let lines = [];
  lines.push(`REDIRECT_URI: ${REDIRECT_URI}`);
  if (err) lines.push(`error: ${err}`);

  if (gotState) {
    lines.push(`state: ${gotState} (expected: ${expected || "(none)"} )`);
  } else {
    lines.push("state: (missing)");
  }

  if (token) {
    lines.push(`token param: ${token.substring(0, 80)}${token.length>80?"…":""}`);
    lines.push("decoded token (best-effort):");
    lines.push(decodeJWT(token));
  } else {
    lines.push("token param: (missing)");
  }

  if (reqJwt) {
    lines.push("original request JWT:");
    lines.push(reqJwt);
  }

  out.classList.remove("err","ok");
  if (!err && token && gotState && expected && gotState === expected) {
    out.classList.add("ok");
  } else if (err) {
    out.classList.add("err");
  }
  out.textContent = lines.join("\n");
})();
</script>
</body>
</html>
