<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Safari SSO Redirect (register/auth/status)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;color:#111}
    button{padding:8px 12px;margin:4px 6px 12px 0}
    pre{background:#f7f7f9;border:1px solid #e5e5ea;padding:12px;border-radius:8px;overflow:auto;white-space:pre-wrap}
    .ok{background:#e8f8ef}.err{background:#fde8e8}
    .muted{color:#666}
  </style>
</head>
<body>
<h1>Redirect-type SSO (Safari)</h1>
<p class="muted">This page does a <b>top-level navigation</b> to apps.pingone.com so the SSO extension runs, then expects a redirect back here with <code>?state=…&token=…</code> (or in the URL fragment).</p>

<!-- OPTIONAL: change only if your paths differ -->
<script>
  const SSO_BASE = "https://apps.pingone.com/pingid/desktop";
  const ROUTES = {
    registration: "/register",
    authentication: "/authentication",
    status: "/status"
  };
  const REDIRECT_URI = location.origin + location.pathname; // self
</script>

<div>
  <button onclick="kickoff('registration')">Registration</button>
  <button onclick="kickoff('authentication')">Authentication</button>
  <button onclick="kickoff('status')">Status</button>
  <button onclick="clearView()">Clear</button>
</div>

<h3>Request</h3>
<pre id="req">(none)</pre>

<h3>Result</h3>
<pre id="res">(none)</pre>

<script>
/* ---------- helpers ---------- */
function isSafari(){
  const ua = navigator.userAgent;
  return /^((?!chrome|android).)*safari/i.test(ua);
}
function randState(){
  const a = new Uint8Array(16); crypto.getRandomValues(a);
  return Array.from(a, x => x.toString(16).padStart(2,'0')).join('');
}
function set(id, v){ document.getElementById(id).textContent = v; }
function b64url(s){ return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function encodeDummyJWT(payloadObj){
  const h = b64url(JSON.stringify({alg:"HS256",typ:"JWT"}));
  const p = b64url(JSON.stringify(payloadObj));
  const s = b64url("dummy-signature");
  return `${h}.${p}.${s}`;
}
function decodeJWT(jwt){
  try{
    const [h,p] = jwt.split('.');
    const hdr = JSON.parse(atob(h.replace(/-/g,'+').replace(/_/g,'/')));
    const pl  = JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));
    return JSON.stringify({header:hdr,payload:pl}, null, 2);
  }catch{ return "(could not decode JWT)"; }
}

/* ---------- kickoff top-level nav (Safari) ---------- */
function kickoff(kind){
  const route = ROUTES[kind];
  if (!route){ set('req', `Unknown kind: ${kind}`); return; }

  // Example demo payload only (not required for the redirect itself)
  const demoJWT = encodeDummyJWT({action: kind, ts: Date.now()});
  const state   = randState();

  // Persist for round-trip validation
  sessionStorage.setItem("sso_state", state);

  // Build the SSO URL — MUST match your Redirect profile's 'URLs' prefix
  const u = new URL(SSO_BASE + route);
  u.searchParams.set("redirect_uri", REDIRECT_URI); // self
  u.searchParams.set("state", state);
  // If your extension wants to receive a client-provided JWT/challenge:
  u.searchParams.set("request", demoJWT);

  set('req', `Navigating to:\n${u.toString()}\n\nstate=${state}\nrequest=${demoJWT}`);

  // Top-level navigation (required to invoke Redirect-type SSO)
  if (isSafari()) {
    window.top.location.assign(u.toString());
  } else {
    // Non-Safari won’t invoke the SSO extension; we still navigate so you can test the server path.
    window.location.assign(u.toString());
  }
}

/* ---------- handle redirect back to self ---------- */
(function handleCallback(){
  const res = document.getElementById('res');
  if (!location.search && !location.hash) return; // nothing to display

  // Support both query (?token=…) and fragment (#token=…)
  const qp   = new URLSearchParams(location.search || "");
  const hp   = new URLSearchParams((location.hash || "").replace(/^#/, ""));
  const get  = k => qp.get(k) || hp.get(k);

  const gotState = get("state");
  const token    = get("token") || get("jwt") || get("code") || get("id_token") || get("access_token");
  const error    = get("error");

  const expected = sessionStorage.getItem("sso_state");

  let lines = [];
  lines.push(`redirect_uri: ${REDIRECT_URI}`);
  if (error) lines.push(`error: ${error}`);
  lines.push(`state: ${gotState || "(missing)"}  expected: ${expected || "(none)"}`);

  if (token) {
    lines.push(`token: ${token.substring(0,120)}${token.length>120?'…':''}`);
    lines.push("decoded (best-effort):");
    lines.push(decodeJWT(token));
  } else {
    lines.push("token: (missing)");
  }

  res.classList.remove('ok','err');
  if (!error && token && gotState && expected && gotState === expected) res.classList.add('ok');
  if (error) res.classList.add('err');
  set('res', lines.join("\n"));

  // Clean the URL bar so refresh doesn't re-parse
  const clean = new URL(location.href); clean.search = ""; clean.hash = "";
  history.replaceState(null, "", clean);
})();
function clearView(){
  sessionStorage.removeItem("sso_state");
  set('req', '(none)'); set('res', '(none)');
}
</script>
</body>
</html>
