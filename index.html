<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>SSO Redirect (self-return with payload)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  body{font:14px/1.5 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px}
  button{padding:8px 12px;margin:4px 8px 12px 0}
  pre{background:#f7f7f9;border:1px solid #e5e5ea;padding:12px;border-radius:8px;white-space:pre-wrap;overflow:auto}
  .muted{color:#666}
  .ok{background:#e8f8ef}.err{background:#fde8e8}
</style>
</head>
<body>
<h1>SSO Redirect (Registration / Authentication / Status)</h1>
<p class="muted">Top-level navigate to apps.pingone.com → SSO extension runs → extension redirects back here with <code>#token=…&payload=…&body=…&state=…</code>.</p>

<div>
  <button onclick="start('registration')">Registration</button>
  <button onclick="start('authentication')">Authentication</button>
  <button onclick="start('status')">Status</button>
  <button onclick="clearView()">Clear</button>
</div>

<h3>Request</h3>
<pre id="req">(none)</pre>

<h3>Returned Data</h3>
<pre id="res">(none)</pre>

<script>
/*** CONFIG ***/
const SSO_BASE = "https://apps.pingone.com/pingid/desktop";
const ROUTES   = {
  registration: "/register",
  authentication: "/authentication",
  status: "/status",
};
const REDIRECT_URI = location.origin + location.pathname; // return here

/*** Helpers ***/
const isSafari = () => /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const b64url   = s => btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
const fromB64u = s => atob(s.replace(/-/g,'+').replace(/_/g,'/'));
function randState(){ const a=new Uint8Array(16); crypto.getRandomValues(a); return Array.from(a,x=>x.toString(16).padStart(2,'0')).join(''); }
function set(id, v){ document.getElementById(id).textContent = v; }
function tryParseJSON(s){ try{ return JSON.stringify(JSON.parse(s), null, 2); }catch{ return s; } }

/*** Kickoff (top-level navigation) ***/
function start(kind){
  const route = ROUTES[kind];
  if (!route) { set('req', `Unknown kind: ${kind}`); return; }

  // Save any local context you want to restore later
  sessionStorage.setItem("ctx_scrollY", String(window.scrollY));

  const state = randState();
  sessionStorage.setItem("sso_state", state);

  // If your extension wants a client-side challenge/request, add it here
  const clientHint = b64url(JSON.stringify({ page:"/test2/", action:kind, at: Date.now() }));

  const u = new URL(SSO_BASE + route);
  u.searchParams.set("redirect_uri", REDIRECT_URI); // self
  u.searchParams.set("state", state);
  u.searchParams.set("client", clientHint);        // optional, for your extension

  set('req', `Top-level nav → ${u.toString()}\nstate=${state}`);

  // Top-level navigation is required to invoke Redirect-type SSO
  window.top.location.assign(u.toString());
}

/*** Handle return (query or fragment) ***/
(function handleReturn(){
  const qp = new URLSearchParams(location.search || "");
  const hp = new URLSearchParams((location.hash || "").replace(/^#/,''));
  const get = k => qp.get(k) || hp.get(k);

  const token   = get("token")   || get("jwt") || get("id_token") || get("access_token");
  const payload = get("payload");  // base64url-encoded JSON your extension returns
  const body    = get("body");     // base64url-encoded raw HTTP body (if you choose to return it)
  const state   = get("state");
  const error   = get("error");

  if (!(token || payload || body || state || error)) return; // no return data

  const expected = sessionStorage.getItem("sso_state");

  let lines = [];
  lines.push(`redirect_uri: ${REDIRECT_URI}`);
  if (error) lines.push(`error: ${error}`);

  lines.push(`state: ${state || "(missing)"}  expected: ${expected || "(none)"}`);

  if (token) {
    lines.push("\n— token (truncated) —");
    lines.push(token.length > 200 ? token.slice(0,200)+"…" : token);
    // Try to decode JWT payload if it looks like a JWT
    const parts = token.split('.');
    if (parts.length >= 2) {
      try { lines.push("\n— decoded JWT payload —\n" + tryParseJSON(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')))); } catch {}
    }
  }

  if (payload) {
    try { lines.push("\n— payload (JSON) —\n" + tryParseJSON(fromB64u(payload))); }
    catch { lines.push("\n— payload (raw) —\n" + payload); }
  }

  if (body) {
    try { lines.push("\n— httpBody (UTF-8) —\n" + fromB64u(body)); }
    catch { lines.push("\n— httpBody (base64url) —\n" + body); }
  }

  const ok = (!error && state && expected && state === expected);
  const res = document.getElementById('res');
  res.classList.toggle('ok',  ok);
  res.classList.toggle('err', !!error);
  set('res', lines.join("\n"));

  // Restore context and clean URL bar
  const y = parseInt(sessionStorage.getItem("ctx_scrollY") || "0", 10);
  setTimeout(()=>window.scrollTo({top:y,behavior:"instant"}), 0);

  const clean = new URL(location.href); clean.search=""; clean.hash="";
  history.replaceState(null, "", clean);
})();

function clearView(){
  sessionStorage.removeItem("sso_state");
  set('req','(none)'); set('res','(none)');
}
</script>
</body>
</html>
