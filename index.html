<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Credential-type SSO Extension — XHR Handshake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font:14px/1.4 -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:2rem;}
    h1{font-size:20px; margin:0 0 .5rem}
    .row{margin:.5rem 0}
    input,button{padding:.6rem .8rem}
    input{width:100%}
    pre{background:#f7f7f9; border:1px solid #eee; padding:1rem; overflow:auto}
    .muted{color:#666}
  </style>
</head>
<body>
  <h1>Credential-type SSO Extension — Direct fetch()</h1>
  <p class="muted">
    Click “Send Request” to POST a challenge to your associated host
    <code>https://apps.pingone.com/pingid/desktop/handshake</code>.
    Safari will route this call to your credential SSO extension.
    The extension should return JSON with a signature/JWT. No redirects involved.
  </p>

  <div class="row">
    <label>Endpoint (under your associated host):</label>
    <input id="endpoint" type="text" value="https://apps.pingone.com/pingid/desktop/handshake"/>
  </div>

  <div class="row">
    <label>Expected fields in JSON response (editable):</label>
    <input id="expect" type="text" value="device_sig,device_key_id,jwt"/>
  </div>

  <div class="row">
    <button id="sendBtn">Send Request</button>
    <button id="clearBtn" style="margin-left:.5rem">Clear</button>
  </div>

  <h2>Request</h2>
  <pre id="reqOut">(none)</pre>

  <h2>Response</h2>
  <pre id="resOut">(none)</pre>

  <script>
  // ---------- helpers ----------
  function b64urlFromBytes(bytes) {
    let s = ""; for (let i=0;i<bytes.length;i++) s += String.fromCharCode(bytes[i]);
    return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }
  function randB64url(n=32){ const b=new Uint8Array(n); crypto.getRandomValues(b); return b64urlFromBytes(b); }
  function setPre(id, obj){ document.getElementById(id).textContent = typeof obj === "string" ? obj : JSON.stringify(obj,null,2); }

  // ---------- build a challenge the extension will sign ----------
  function buildChallenge() {
    const payload = { ver:1, ts: Date.now(), nonce: randB64url(16) };
    const raw = new TextEncoder().encode(JSON.stringify(payload));
    return { payload, chal: b64urlFromBytes(raw) };
  }

  // ---------- send POST to associated host (intercepted by OS/extension) ----------
  async function sendRequest() {
    const endpoint = document.getElementById("endpoint").value.trim();
    const expected = document.getElementById("expect").value.split(",").map(s=>s.trim()).filter(Boolean);

    const { payload, chal } = buildChallenge();
    const body = {
      device_chal: chal,                     // challenge (base64url)
      state: randB64url(16),                 // optional correlation value
      // add any hints the extension needs (e.g., key id, user hint, policy)
      // device_key_hint: "key-123"
    };

    setPre("reqOut", { url: endpoint, method: "POST", body });

    // Normal fetch — NOT a navigation. Safari will intercept and route to your extension.
    let r;
    try {
      r = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
        // If your extension returns cookies and you want them: credentials: "include"
      });
    } catch (e) {
      setPre("resOut", `Network error: ${e}`);
      return;
    }

    // CORS note: your extension must set Access-Control-Allow-Origin to allow reading this.
    const text = await r.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    setPre("resOut", { status: r.status, headers: Object.fromEntries(r.headers.entries()), data });

    // Optional: quick sanity checks
    const missing = expected.filter(k => !(k in (data || {})));
    if (missing.length) {
      console.warn("Missing expected keys:", missing);
    } else {
      console.log("All expected keys present.");
    }
  }

  document.getElementById("sendBtn").addEventListener("click", sendRequest);
  document.getElementById("clearBtn").addEventListener("click", () => { setPre("reqOut", "(none)"); setPre("resOut", "(none)"); });
  </script>
</body>
</html>
